name: é•œåƒåŒæ­¥åˆ°é˜¿é‡Œäº‘ä»“åº“

on:
  workflow_dispatch:
    inputs:
      IMAGE_LIST:
        description: "è¯·åœ¨"IMAGE_LIST"è¾“å…¥è¦åŒæ­¥çš„é•œåƒåˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼Œä¾‹å¦‚ï¼šnginx:latest,redis/redis:latestï¼‰"
        required: true
        default: "nginx:latest"

  push:
    branches: [ main ]

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"               # ä¾‹ï¼šregistry.cn-hangzhou.aliyuncs.com
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"           # é˜¿é‡Œäº‘å‘½åç©ºé—´
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"     # é˜¿é‡Œäº‘ç”¨æˆ·å
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" # é˜¿é‡Œäº‘å¯†ç æˆ–Token

  DOCKERHUB_USER: "${{ secrets.DOCKERHUB_USER }}"                 # DockerHub ç”¨æˆ·å
  DOCKERHUB_TOKEN: "${{ secrets.DOCKERHUB_TOKEN }}"               # DockerHub Token (æ”¯æŒç§æœ‰é•œåƒæ‹‰å–)

jobs:
  sync:
    name: åŒæ­¥é•œåƒåˆ°é˜¿é‡Œäº‘
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¹ æŸ¥çœ‹åˆå§‹ç£ç›˜ç©ºé—´
        run: |
          df -hT

      - name: ğŸ’¾ é‡Šæ”¾æ„å»ºç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: 'true'
          remove-haskell: 'true'
          build-mount-path: '/var/lib/docker/'

      - name: ğŸ” é‡å¯ Docker æœåŠ¡
        run: sudo service docker restart

      - name: âœ… æŸ¥çœ‹é‡Šæ”¾åç£ç›˜ç©ºé—´
        run: df -hT

      - name: ğŸ“¦ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4

      - name: ğŸ§° å®‰è£… Buildx ç¯å¢ƒ
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“
        run: |
          echo "$ALIYUN_REGISTRY_PASSWORD" | docker login -u "$ALIYUN_REGISTRY_USER" --password-stdin "$ALIYUN_REGISTRY"

      - name: ğŸ” ç™»å½• Docker Hubï¼ˆç”¨äºæ‹‰å–ç§æœ‰é•œåƒï¼‰
        run: |
          if [ -n "$DOCKERHUB_USER" ] && [ -n "$DOCKERHUB_TOKEN" ]; then
            echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USER" --password-stdin
          else
            echo "æœªé…ç½® Docker Hub å‡­æ®ï¼Œå°†ä»…èƒ½æ‹‰å–å…¬å…±é•œåƒã€‚"
          fi

      - name: ğŸš€ å¼€å§‹åŒæ­¥é•œåƒåˆ°é˜¿é‡Œäº‘
        run: |
          set -e
          IFS=',' read -ra IMAGES <<< "${{ github.event.inputs.IMAGE_LIST }}"

          for image in "${IMAGES[@]}"; do
            echo "============================"
            echo "å‡†å¤‡åŒæ­¥é•œåƒ: $image"
            echo "============================"

            # å»æ‰å¤šä½™ç©ºæ ¼
            image=$(echo "$image" | xargs)

            # æ£€æŸ¥æ˜¯å¦åŒ…å« tagï¼Œæ²¡æœ‰åˆ™é»˜è®¤ latest
            if [[ "$image" != *":"* ]]; then
              image="$image:latest"
            fi

            # æå–å‘½åç©ºé—´å’Œé•œåƒå
            image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
            name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print "library"}')
            image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')

            echo "å‘½åç©ºé—´: $name_space"
            echo "é•œåƒåç§°: $image_name_tag"

            # å°è¯•æ‹‰å–é•œåƒï¼ˆè‡ªåŠ¨åˆ¤æ–­æ¶æ„ï¼‰
            echo "ğŸ”½ æ‹‰å–é•œåƒ $image"
            docker pull "$image"

            # æ”¯æŒå¤šæ¶æ„çš„æ ‡ç­¾å‘½åï¼ˆè‡ªåŠ¨ç”Ÿæˆå”¯ä¸€å‰ç¼€ï¼‰
            platform=$(docker inspect "$image" --format '{{.Architecture}}' || echo "unknown")
            platform_prefix="${platform//\//_}_"

            # ç”Ÿæˆæ–°çš„é˜¿é‡Œäº‘é•œåƒåœ°å€
            new_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/${platform_prefix}${name_space}_${image_name_tag}"

            echo "ğŸ·ï¸ æ ‡è®°é•œåƒ: $new_image"
            docker tag "$image" "$new_image"

            echo "â¬†ï¸ æ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘..."
            docker push "$new_image"

            echo "ğŸ§¹ æ¸…ç†é•œåƒé‡Šæ”¾ç©ºé—´"
            docker rmi "$image" || true
            docker rmi "$new_image" || true

            echo "âœ… é•œåƒåŒæ­¥å®Œæˆ: $image -> $new_image"
          done

      - name: ğŸ§¾ æŸ¥çœ‹åŒæ­¥åçš„ç£ç›˜ç©ºé—´
        run: df -hT
